<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Global Money Jar</title>

  <style>
    body {
      margin: 0;
      min-height: 100vh;
      display: grid;
      place-items: center;
      background: #f6f7fb;
      font-family: system-ui, -apple-system, sans-serif;
    }

    .wrap {
      text-align: center;
    }

    #total {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 16px;
    }

    #jarBtn {
      background: white;
      border: none;
      width: 220px;
      height: 220px;
      border-radius: 24px;
      font-size: 6rem;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }

    #removeBtn {
      margin-top: 14px;
      background: white;
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 12px;
      padding: 10px 14px;
      font-size: 1rem;
      font-weight: 650;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }

    #removeBtn:active {
      transform: translateY(1px);
    }

    #jarBtn.shake {
      animation: shake 0.2s;
    }

    @keyframes shake {
      0% { transform: translateX(0) rotate(0deg); }
      25% { transform: translateX(-6px) rotate(-20deg); }
      50% { transform: translateX(6px) rotate(20deg); }
      75% { transform: translateX(-4px) rotate(-12deg); }
      100% { transform: translateX(0) rotate(0deg); }
    }

    .pop {
      position: absolute;
      font-weight: 800;
      animation: pop 0.7s ease-out forwards;
      pointer-events: none;
    }

    @keyframes pop {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-40px); }
    }
  </style>
</head>
<body>

  <div class="wrap">
    <div id="total">$0.00</div>
    <button id="jarBtn">ðŸ«™</button>
    <button id="removeBtn">Remove $1.00</button>
  </div>

  <!-- ðŸ”¹ Local animations -->
  <script>
    function shake() {
      const btn = document.getElementById("jarBtn");
      btn.classList.remove("shake");
      void btn.offsetWidth;
      btn.classList.add("shake");
    }

    function spawnPop(text) {
      const pop = document.createElement("div");
      pop.className = "pop";
      pop.textContent = text;
      pop.style.left = "50%";
      pop.style.top = "45%";
      document.body.appendChild(pop);
      setTimeout(() => pop.remove(), 700);
    }
  </script>

  <!-- ðŸ”¹ Firebase / shared jar logic -->
 <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    onSnapshot,
    runTransaction,
    setDoc,
    updateDoc,
    increment
  } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCoT43XB2GKEyUH0gowOshm4EQ48LkHldI",
    authDomain: "cogmedy-jar.firebaseapp.com",
    projectId: "cogmedy-jar",
    storageBucket: "cogmedy-jar.firebasestorage.app",
    messagingSenderId: "352395359670",
    appId: "1:352395359670:web:b30af374a4e4102ba37d17"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  await signInAnonymously(auth);

  const jarRef = doc(db, "jars", "global");

  // Only create the doc once, the very first time
  const existing = await getDoc(jarRef);
  if (!existing.exists()) {
    await setDoc(jarRef, { totalCents: 0 });
  }

  const totalEl = document.getElementById("total");
  const jarBtn = document.getElementById("jarBtn");
  const removeBtn = document.getElementById("removeBtn");

  function formatDollars(cents) {
    return `$${(cents / 100).toFixed(2)}`;
  }

  onSnapshot(jarRef, (snap) => {
    const cents = snap.data()?.totalCents ?? 0;
    totalEl.textContent = formatDollars(cents);
  });

  const ADD_CENTS = 100;

  jarBtn.addEventListener("click", async () => {
    await updateDoc(jarRef, { totalCents: increment(ADD_CENTS) });
    shake();
    spawnPop("+ $1.00");
  });

  removeBtn.addEventListener("click", async () => {
    let removed = 0;

    await runTransaction(db, async (tx) => {
      const snap = await tx.get(jarRef);
      const current = snap.data()?.totalCents ?? 0;

      if (current <= 0) {
        removed = 0;
        return;
      }

      const next = Math.max(0, current - ADD_CENTS);
      removed = current - next;
      tx.update(jarRef, { totalCents: next });
    });

    shake();
    spawnPop(removed > 0 ? "- $1.00" : "$0.00");
  });
</script>


</body>
</html>
